<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxGen Pro Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0b0f19',
                        panel: '#151b2b',
                        accent: '#6366f1',
                        accentHover: '#4f46e5'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background: #0b0f19; color: #e2e8f0; }
        
        /* Glassmorphism & Utilities */
        .glass-panel {
            background: rgba(21, 27, 43, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        /* Ranges */
        input[type=range] {
            -webkit-appearance: none; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #6366f1; cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }

        /* Loading Animation */
        .shimmer {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-64 bg-panel border-r border-slate-800 flex flex-col hidden md:flex z-20">
        <div class="p-6 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                <i class="fa-solid fa-layer-group text-white text-sm"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-white">FluxGen <span class="text-indigo-400">Pro</span></h1>
        </div>

        <nav class="flex-1 px-3 space-y-1 overflow-y-auto custom-scrollbar">
            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3 mt-4">Models</div>
            
            <button onclick="selectModel('flux-dev')" id="nav-flux-dev" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-indigo-600/10 text-indigo-400 border border-indigo-500/20">
                <i class="fa-solid fa-bolt mr-2"></i> Flux Dev (Default)
            </button>
            <button onclick="selectModel('flux-klein')" id="nav-flux-klein" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-wind mr-2"></i> Flux Klein 9B
            </button>
            <button onclick="selectModel('lucid-origin')" id="nav-lucid-origin" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-gem mr-2 text-amber-400"></i> Lucid Origin
            </button>
            <button onclick="selectModel('dreamshaper')" id="nav-dreamshaper" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-camera mr-2"></i> DreamShaper 8
            </button>
            <button onclick="selectModel('stable-diffusion-xl-lightning')" id="nav-stable-diffusion-xl-lightning" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-bolt-lightning mr-2 text-yellow-400"></i> SDXL Lightning
            </button>
            <button onclick="selectModel('stable-diffusion-xl-base')" id="nav-stable-diffusion-xl-base" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-cube mr-2"></i> SDXL Base 1.0
            </button>
            
            <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3 mt-6">Tools</div>
            <button onclick="selectModel('stable-diffusion-img2img')" id="nav-stable-diffusion-img2img" class="w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors">
                <i class="fa-solid fa-wand-magic mr-2 text-pink-400"></i> Img2Img (SD 1.5)
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center justify-between text-xs text-slate-500">
                <span id="storage-status"><i class="fa-solid fa-database mr-1"></i> Storage: ...</span>
                <button onclick="clearHistory()" class="hover:text-red-400 transition">Clear</button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <div class="md:hidden flex items-center justify-between p-4 bg-panel border-b border-slate-800">
            <h1 class="font-bold">FluxGen Pro</h1>
            <button class="text-slate-400"><i class="fa-solid fa-bars"></i></button>
        </div>

        <div class="flex-1 flex overflow-hidden">
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 lg:p-10 scroll-smooth">
                
                <div class="max-w-4xl mx-auto space-y-8">
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-end">
                            <label class="text-sm font-medium text-indigo-400 uppercase tracking-wider">Positive Prompt</label>
                            <span id="activeModelLabel" class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-400 border border-slate-700">Flux Dev</span>
                        </div>
                        <div class="relative group">
                            <textarea id="promptInput" rows="3" 
                                class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 text-base focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all placeholder-slate-600 resize-none shadow-inner text-white"
                                placeholder="A futuristic city with bioluminescent plants, cinematic lighting, 8k resolution..."></textarea>
                            <button onclick="generate()" id="genBtn" class="absolute bottom-3 right-3 bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-lg shadow-lg transition-all flex items-center gap-2 px-4 font-medium">
                                <span>Generate</span> <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>

                        <div id="imgInputContainer" class="hidden animate-fade-in">
                            <label class="text-sm font-medium text-slate-400 mb-2 block">Source Image (Required for Img2Img)</label>
                            <div class="border-2 border-dashed border-slate-700 rounded-xl p-6 text-center hover:bg-slate-800/50 transition-colors relative">
                                <input type="file" id="imageUpload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleImageSelect(this)">
                                <div id="uploadPlaceholder">
                                    <i class="fa-solid fa-cloud-upload-alt text-2xl text-slate-500 mb-2"></i>
                                    <p class="text-sm text-slate-400">Click or Drag image here</p>
                                </div>
                                <img id="previewUpload" class="hidden h-32 mx-auto rounded shadow-lg object-contain">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-panel p-6 rounded-xl border border-slate-800">
                        
                        <div class="col-span-1 md:col-span-2">
                            <label class="text-xs font-semibold text-slate-500 uppercase mb-2 block">Negative Prompt</label>
                            <input type="text" id="negativePrompt" 
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm focus:border-indigo-500 outline-none text-slate-300"
                                placeholder="blurry, low quality, distorted, ugly...">
                        </div>

                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-400">Width</span>
                                <span id="widthVal" class="text-indigo-400 font-mono">1024</span>
                            </div>
                            <input type="range" id="widthInput" min="256" max="1440" step="64" value="1024" oninput="updateRange('width', this.value)">
                        </div>
                        
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-400">Height</span>
                                <span id="heightVal" class="text-indigo-400 font-mono">768</span>
                            </div>
                            <input type="range" id="heightInput" min="256" max="1440" step="64" value="768" oninput="updateRange('height', this.value)">
                        </div>
                    </div>

                    <div class="relative bg-black/40 rounded-2xl border border-slate-800 overflow-hidden min-h-[500px] flex items-center justify-center group" id="viewport">
                        
                        <div id="placeholderState" class="text-center">
                            <div class="w-24 h-24 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <i class="fa-solid fa-wand-magic-sparkles text-4xl text-slate-700"></i>
                            </div>
                            <h3 class="text-slate-300 font-medium">Ready to Create</h3>
                            <p class="text-slate-500 text-sm mt-1">Select a model and type a prompt</p>
                        </div>

                        <div id="loadingState" class="hidden absolute inset-0 z-10 flex flex-col items-center justify-center bg-dark/80 backdrop-blur-sm">
                            <div class="w-64 h-2 bg-slate-800 rounded-full overflow-hidden relative">
                                <div class="absolute inset-0 bg-indigo-500 animate-[loading_2s_ease-in-out_infinite] w-1/2"></div>
                            </div>
                            <p class="mt-4 text-indigo-400 font-mono text-sm animate-pulse">Processing GPU Request...</p>
                        </div>

                        <img id="resultImage" class="hidden max-w-full max-h-[700px] shadow-2xl transition-transform duration-500 hover:scale-[1.01]">
                        
                        <div id="resultActions" class="hidden absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 to-transparent flex justify-center gap-4 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                            <a id="downloadLink" download class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg backdrop-blur-md flex items-center gap-2 cursor-pointer border border-white/10">
                                <i class="fa-solid fa-download"></i> Download
                            </a>
                        </div>
                    </div>

                    <div class="pt-8 border-t border-slate-800">
                        <h3 class="text-lg font-semibold text-white mb-4">Recent Generations</h3>
                        <div id="historyGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Configuration ---
        const API_BASE = "https://wild-art-dca7.veltrix620.workers.dev";
        let state = {
            model: 'flux-dev', // Default ID
            modelName: 'Flux 2 Dev',
            base64Input: null
        };

        const endpoints = {
            'flux-dev': { url: '/flux-dev', name: 'Flux 2 Dev' },
            'flux-klein': { url: '/flux-klein', name: 'Flux Klein 9B' },
            'lucid-origin': { url: '/lucid-origin', name: 'Lucid Origin' },
            'dreamshaper': { url: '/dreamshaper', name: 'DreamShaper 8' },
            'stable-diffusion-img2img': { url: '/stable-diffusion-img2img', name: 'SD 1.5 Img2Img', needsImage: true },
            'stable-diffusion-xl-lightning': { url: '/stable-diffusion-xl-lightning', name: 'SDXL Lightning' },
            'stable-diffusion-xl-base': { url: '/stable-diffusion-xl-base', name: 'SDXL Base 1.0' }
        };

        // --- IndexedDB ---
        let db;
        const DB_NAME = 'FluxProDB';
        const STORE_NAME = 'generations';

        function initDB() {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    const store = db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
                    store.createIndex("date", "date", { unique: false });
                }
            };
            request.onsuccess = (e) => {
                db = e.target.result;
                loadHistory();
                updateStorageInfo();
            };
        }

        // --- UI Interactions ---

        function selectModel(id) {
            // Update State
            state.model = id;
            state.modelName = endpoints[id].name;
            
            // Update Sidebar UI
            document.querySelectorAll('aside button').forEach(b => {
                b.className = "w-full text-left px-3 py-2 rounded-lg text-sm font-medium text-slate-400 hover:bg-slate-800 transition-colors";
            });
            const activeBtn = document.getElementById(`nav-${id}`);
            if(activeBtn) {
                activeBtn.className = "w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors bg-indigo-600/10 text-indigo-400 border border-indigo-500/20";
            }

            // Update Label
            document.getElementById('activeModelLabel').innerText = state.modelName;

            // Handle Img2Img UI
            const imgContainer = document.getElementById('imgInputContainer');
            if (endpoints[id].needsImage) {
                imgContainer.classList.remove('hidden');
            } else {
                imgContainer.classList.add('hidden');
                state.base64Input = null; // Clear if switching away
                document.getElementById('imageUpload').value = "";
                resetUploadPreview();
            }
        }

        function updateRange(type, val) {
            document.getElementById(`${type}Val`).innerText = val;
        }

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.base64Input = e.target.result; // Store full data URI
                    
                    // Update Preview
                    const preview = document.getElementById('previewUpload');
                    const placeholder = document.getElementById('uploadPlaceholder');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function resetUploadPreview() {
            document.getElementById('previewUpload').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
        }

        // --- Generation Logic ---

        async function generate() {
            const prompt = document.getElementById('promptInput').value.trim();
            const negPrompt = document.getElementById('negativePrompt').value.trim();
            const width = document.getElementById('widthInput').value;
            const height = document.getElementById('heightInput').value;
            const btn = document.getElementById('genBtn');

            // Validation
            if (!prompt) {
                alert("Please write a prompt first!");
                return;
            }
            if (endpoints[state.model].needsImage && !state.base64Input) {
                alert("This model requires a source image. Please upload one.");
                return;
            }

            // UI Loading State
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultImage').classList.add('hidden');
            document.getElementById('resultActions').classList.add('hidden');

            try {
                // Determine Endpoint
                const config = endpoints[state.model];
                let fullUrl = `${API_BASE}${config.url}`;
                
                // Build Query Parameters (Default behavior for this API seems to be GET based on user example)
                // However, for Img2Img or complex params, we might need POST. 
                // Given the constraints, we will attempt to construct a URL with params for standard models
                // For Img2Img, we likely need to POST JSON if the worker supports it, otherwise GET will fail with base64.
                // *Assumption*: The worker handles Query Params for text-to-image.
                
                const params = new URLSearchParams({
                    prompt: prompt,
                    width: width,
                    height: height
                });

                if (negPrompt) params.append('negative_prompt', negPrompt);
                
                let fetchOptions = { method: 'GET' };

                // Special handling for Img2Img (Must use POST usually, but if user API is strict...)
                // We will try standard POST for everything if possible, but user provided GET example.
                // Let's try to pass parameters in URL for text models, and hope Img2Img accepts body or handle error.
                
                // Strategy: Use GET for text models (proven). Use POST for Img2Img.
                
                if (config.needsImage) {
                    // Switch to POST for image upload
                    fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: prompt,
                            negative_prompt: negPrompt,
                            width: parseInt(width),
                            height: parseInt(height),
                            image: state.base64Input, // The worker likely expects this field
                            image_b64: state.base64Input // Sending both common keys just in case
                        })
                    };
                    // Clean URL for POST
                    fullUrl = `${API_BASE}${config.url}`; 
                } else {
                    fullUrl += `?${params.toString()}`;
                }

                const response = await fetch(fullUrl, fetchOptions);
                const data = await response.json();

                if (data.success || data.image) {
                    const finalImage = data.image; // Should be Base64 string
                    
                    // Display
                    const imgEl = document.getElementById('resultImage');
                    imgEl.src = finalImage;
                    imgEl.onload = () => {
                        document.getElementById('loadingState').classList.add('hidden');
                        imgEl.classList.remove('hidden');
                        document.getElementById('resultActions').classList.remove('hidden');
                    };

                    // Setup Download
                    const dlLink = document.getElementById('downloadLink');
                    dlLink.href = finalImage;
                    dlLink.download = `flux-${Date.now()}.png`;

                    // Save to History
                    saveToHistory({
                        id: Date.now(),
                        image: finalImage,
                        prompt: prompt,
                        model: state.modelName,
                        date: new Date()
                    });

                } else {
                    throw new Error(data.error || "Generation failed");
                }

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('placeholderState').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // --- History & Storage ---

        function saveToHistory(record) {
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).add(record);
            tx.oncomplete = () => {
                loadHistory();
                updateStorageInfo();
            };
        }

        function loadHistory() {
            const tx = db.transaction(STORE_NAME, "readonly");
            const store = tx.objectStore(STORE_NAME);
            const index = store.index("date");
            
            const grid = document.getElementById('historyGrid');
            grid.innerHTML = ''; // Clear

            // Iterate backwards
            index.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    renderCard(cursor.value, grid);
                    cursor.continue();
                }
            };
        }

        function renderCard(data, container) {
            const div = document.createElement('div');
            div.className = "group relative aspect-square bg-slate-800 rounded-xl overflow-hidden border border-slate-700 cursor-pointer";
            div.onclick = () => loadFromHistory(data);

            div.innerHTML = `
                <img src="${data.image}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3">
                    <span class="text-xs text-indigo-300 font-bold mb-1">${data.model}</span>
                    <p class="text-xs text-white line-clamp-2 opacity-80">${data.prompt}</p>
                </div>
            `;
            container.appendChild(div);
        }

        function loadFromHistory(data) {
            // Restore Image to main view
            const imgEl = document.getElementById('resultImage');
            imgEl.src = data.image;
            imgEl.classList.remove('hidden');
            document.getElementById('placeholderState').classList.add('hidden');
            document.getElementById('resultActions').classList.remove('hidden');
            
            // Setup Download
            const dlLink = document.getElementById('downloadLink');
            dlLink.href = data.image;
            dlLink.download = `flux-history-${data.id}.png`;
        }

        function clearHistory() {
            if(confirm("Clear all generation history?")) {
                const tx = db.transaction(STORE_NAME, "readwrite");
                tx.objectStore(STORE_NAME).clear();
                tx.oncomplete = () => {
                    loadHistory();
                    updateStorageInfo();
                };
            }
        }

        async function updateStorageInfo() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usedMB = (estimate.usage / (1024 * 1024)).toFixed(1);
                document.getElementById('storage-status').innerHTML = `<i class="fa-solid fa-database mr-1"></i> Storage: ${usedMB} MB`;
            }
        }

        // Init
        window.onload = initDB;

        // Add Loading keyframe animation
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes loading {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(200%); }
            }
            .animate-fade-in { animation: fadeIn 0.3s ease-in; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>
